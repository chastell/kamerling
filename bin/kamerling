#!/usr/bin/env ruby

require 'optparse'
require_relative '../lib/kamerling'

Config = Struct.new :db, :host, :tcp, :udp
c      = Config.new nil, GServer::DEFAULT_HOST, 0, 0

OptionParser.new do |opts|
  opts.on('--db foo.sqlite3', String,  'SQLite path') { |db|   c.db   = db   }
  opts.on('--host 127.0.0.1', String,  'server host') { |host| c.host = host }
  opts.on('--tcp 0',          Integer, 'TCP port')    { |tcp|  c.tcp  = tcp  }
  opts.on('--udp 0',          Integer, 'UDP port')    { |udp|  c.udp  = udp  }
end.parse! ARGV

Thread.abort_on_exception = true

logger = Logger.new $stdout
logger.level = Logger::INFO

Kamerling::Repos.db = Sequel.sqlite c.db
server = Kamerling::Server.new host: c.host, logger: logger, tcp_port: c.tcp,
  udp_port: c.udp
server.audit = true
server.start
server.join
